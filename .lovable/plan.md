

# خطة إصلاح المشاكل الثلاث

## المشاكل المكتشفة

### 1. مشكلة الدمج: سيرفر FFmpeg Space معطل تماما
السبب الجذري: الرابط `https://ff.hf.space` يرجع **404 - Page Not Found**. السيرفر غير موجود او متوقف. كل محاولات التحقق من حالة الدمج تفشل بنفس الخطأ:
```
Cannot GET /status/job_1770445596064
```
هذا يعني ان كل عمليات الدمج ستبقى عالقة للابد لان السيرفر لا يستجيب.

**البيانات الحالية**: 3 مهام عالقة في حالة `processing` بنسبة 85% بدون `output_url`.

### 2. مشكلة ElevenLabs: المفاتيح تُلغى تفعيلها تلقائيا
السبب: الكود الحالي في `elevenlabs.ts` لا يحتوي على اي منطق لاعادة المحاولة. عند فشل اي مفتاح (حتى لو كان خطأ مؤقت)، يرمي خطأ ويفشل الوظيفة بالكامل. 3 من 4 مفاتيح معطلة حاليا (`is_active: false`).

### 3. مشكلة الواجهة: صفحة تفاصيل المهمة بالتصميم القديم
صفحة `JobDetails.tsx` لا تستخدم `DashboardLayout` وتحتوي على class `dark` ثابت، مما يجعلها تظهر بالثيم الداكن القديم بينما باقي الصفحات بالثيم الفاتح الجديد.

---

## خطة الاصلاح

### المرحلة 1: اصلاح سيرفر FFmpeg والتعامل مع التعطل

**الملفات**: `_shared/huggingface.ts`, `job-status/index.ts`

- اضافة فحص سريع لحالة السيرفر قبل بدء الدمج (health check)
- اذا كان السيرفر لا يستجيب: فشل فوري مع رسالة واضحة بدلا من الانتظار اللانهائي
- تحسين `checkMergeStatus` ليكتشف استجابات HTML (صفحات خطأ) ويميزها عن JSON
- اضافة حد اقصى لعدد محاولات الـ polling المتتالية الفاشلة (مثلا 10 محاولات فاشلة = فشل المهمة)
- تحديث المهام العالقة الحالية في قاعدة البيانات لتكون `failed` مع رسالة توضيحية
- عرض رسالة خطأ واضحة في الواجهة عند تعطل سيرفر الدمج

### المرحلة 2: اصلاح ElevenLabs - نظام اعادة محاولة ذكي

**الملفات**: `_shared/elevenlabs.ts`

- اضافة نظام retry يحاول حتى 3 مفاتيح مختلفة قبل الفشل
- التمييز بين انواع الاخطاء:
  - `detected_unusual_activity` -> تعطيل المفتاح تلقائيا (حظر دائم)
  - `quota_exceeded` -> تعطيل المفتاح مع رسالة واضحة
  - 401 عادي -> اعادة محاولة بمفتاح آخر بدون تعطيل
  - اخطاء اخرى (500, timeout) -> اعادة محاولة بدون تعطيل
- تسجيل log تفصيلي لكل محاولة لتسهيل التشخيص

### المرحلة 3: تحديث واجهة صفحة تفاصيل المهمة

**الملفات**: `src/pages/JobDetails.tsx`

- تغليف الصفحة بـ `DashboardLayout` بدلا من div عادي
- ازالة class `dark` الثابت لاستخدام الثيم الفاتح الجديد
- تطبيق نفس نمط التصميم (الالوان، الظلال، الاتجاه) المستخدم في باقي الصفحات

---

## التفاصيل التقنية

### تغييرات `_shared/huggingface.ts`
- اضافة دالة `isHtmlErrorResponse()` لاكتشاف استجابات HTML بدلا من محاولة parse JSON
- اضافة health check سريع (HEAD request) قبل ارسال طلب الدمج
- تقليل عدد endpoint candidates في `checkMergeStatus` والتركيز على الـ endpoints الصحيحة فقط
- اضافة عداد فشل في `pollForMergeCompletion` - اذا فشلت 10 محاولات متتالية تفشل المهمة

### تغييرات `_shared/elevenlabs.ts`
- `generateSpeech()` يصبح:
  1. جلب كل المفاتيح النشطة
  2. محاولة الاولى بالمفتاح الاقل استخداما
  3. عند فشل -> فحص نوع الخطأ -> تعطيل او اعادة محاولة
  4. المحاولة التالية بمفتاح آخر
  5. اذا كل المفاتيح فشلت -> خطأ نهائي

### تغييرات `job-status/index.ts`
- اضافة عداد لعدد تكرارات فشل فحص حالة الدمج
- تخزين عدد المحاولات الفاشلة في `output_data` الخاص بخطوة الدمج
- اذا وصل العداد الى 20 محاولة فاشلة: تفشيل المهمة تلقائيا مع رسالة "سيرفر الدمج لا يستجيب"

### تغييرات `JobDetails.tsx`
- استبدال `<div className="min-h-screen bg-background dark">` بـ `<DashboardLayout>`
- ازالة الـ container wrapper الزائد
- تحديث الالوان لتتوافق مع الثيم الفاتح

### تنظيف قاعدة البيانات
- تحديث المهام الثلاث العالقة الى `failed` مع رسالة توضيحية
- اعادة تفعيل المفاتيح الصالحة في `elevenlabs_keys`

